<!doctype html>
<html lang="es"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Admin — PEVE</title>
<link rel="stylesheet" href="../assets/style.css">
<script defer src="../assets/app.js"></script>
<script>
window.addEventListener('DOMContentLoaded', async()=>{
  const u = getSession(); if(!u || u.role!=='admin') return location.href='login.html';
  $('#who').textContent = u.name;
  const users = await fetch('../data/users.json').then(r=>r.json());
  const tbody = $('#users-body');
  users.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${x.id}</td><td>${x.name}</td><td><span class="tag">${x.role}</span></td><td>${x.email||'-'}</td>`;
    tbody.appendChild(tr);
  });
});
</script>
<script defer src="../assets/api.js"></script>
</head>
<body>

<header class="header">
  <div class="logo">
    <span class="badge">PEVE</span>
    <span class="title">Plataforma Exámenes de Validación de Estudios</span>
  </div>
  <div class="row">
    <button class="toggle" data-action="fs-dec">A−</button>
    <button class="toggle" data-action="fs-inc">A+</button>
    <button class="toggle" data-action="contrast">🌓 Alto contraste</button>
  </div>
</header>

<main>
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2>🛠️ Administración — <span id="who"></span></h2>
    <button class="toggle" data-action="logout">Cerrar sesión</button>
  </div>
  <div class="grid">
    <div class="card">
      <h3>Usuarios</h3>
      <table class="table">
        <thead><tr><th>ID</th><th>Nombre</th><th>Rol</th><th>Correo</th></tr></thead>
        <tbody id="users-body"></tbody>
      </table>
      <p class="notice">Agregar/editar usuarios requerirá backend real (API o Google Apps Script). Aquí dejamos la UI base.</p>
    </div>
    <div class="card">
      <h3>Asignaturas / Cursos</h3>
      <div class="row">
        <a class="btn" href="../pages/curso_biologia_1m.html">➕ Asignar Biología 1M</a>
      </div>
      <small>Extiende con más asignaturas (Lenguaje, Matemática, Física, Química, Historia, Inglés).</small>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>➕ Crear usuario</h3>
      <div class="row">
        <input id="nu_id" placeholder="id (ej: est2)">
        <input id="nu_name" placeholder="Nombre">
        <select id="nu_role">
          <option value="student">student</option>
          <option value="guardian">guardian</option>
          <option value="teacher">teacher</option>
          <option value="admin">admin</option>
        </select>
        <input id="nu_email" placeholder="Correo">
        <button class="btn green" onclick="createUser()">Crear</button>
      </div>
      <small>Se guardará en la hoja <code>users</code> de tu Google Sheets.</small>
    </div>
    <div class="card">
      <h3>📋 Listar usuarios (desde Sheets)</h3>
      <div class="row"><button class="btn" onclick="loadUsers()">Actualizar</button></div>
      <table class="table"><thead><tr><th>ID</th><th>Nombre</th><th>Rol</th><th>Correo</th></tr></thead><tbody id="users-remote"></tbody></table>
    </div>
  </div>
</main>
<script>
async function createUser(){
  const payload = {
    id: $('#nu_id').value, name: $('#nu_name').value,
    role: $('#nu_role').value, email: $('#nu_email').value
  };
  try{
    const resp = await PEVE_API.pevePost('user_create', payload);
    alert(resp.message || 'Usuario creado');
  }catch(e){ alert('No se pudo crear'); }
}
async function loadUsers(){
  try{
    const resp = await PEVE_API.pevePost('user_list', {});
    const tb = $('#users-remote'); tb.innerHTML='';
    (resp.rows||[]).forEach(x=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${x.id}</td><td>${x.name}</td><td><span class="tag">${x.role}</span></td><td>${x.email||'-'}</td>`;
      tb.appendChild(tr);
    });
  }catch(e){ alert('No se pudo obtener usuarios'); }
}
</script>


<footer class="footer">
  <div>Proyecto Exámenes Libres — Pancho & Belén</div>
  <div>belen.acpe@gmail.com · 📞 +56 9 6266 4960</div>
  <div>👨‍💻 Francisco Pinto — 📧 franciscoandresp@gmail.com · 📞 +56 9 2002 7992</div>
  <div>Hecho con ❤️ para el Liceo Bicentenario de Excelencia Polivalente San Nicolás</div>
</footer>

</body></html>
